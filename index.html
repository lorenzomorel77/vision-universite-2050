<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Vision Université 2050 - Atelier Atrium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        h1, h2, h3, .title-font { font-family: 'Montserrat', sans-serif; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Animation pour l'indicateur audio */
        .speaking-animation { display: flex; gap: 4px; justify-content: center; align-items: flex-end; height: 20px; }
        .bar { width: 4px; background-color: #4F46E5; animation: speak 1s infinite ease-in-out; }
        .bar:nth-child(1) { animation-delay: 0.0s; height: 10px; }
        .bar:nth-child(2) { animation-delay: 0.1s; height: 15px; }
        .bar:nth-child(3) { animation-delay: 0.2s; height: 20px; }
        .bar:nth-child(4) { animation-delay: 0.3s; height: 12px; }
        @keyframes speak { 0%, 100% { height: 5px; } 50% { height: 20px; } }

        /* Styles spécifiques Frise Chrono */
        .timeline-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #E0E7FF; transform: translateX(-50%); }
        .timeline-point { position: absolute; left: 50%; width: 20px; height: 20px; background: #4F46E5; border: 4px solid white; border-radius: 50%; transform: translateX(-50%); z-index: 10; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
        .timeline-card { width: 45%; position: relative; }
        .timeline-card.left { left: 0; text-align: right; padding-right: 40px; }
        .timeline-card.right { left: 55%; text-align: left; padding-left: 40px; }
        
        .selected-persona { border-color: #4F46E5; background-color: #EEF2FF; transform: scale(1.02); }

        /* Animation Nuage de mots */
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .word-tag { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; display: inline-block; }

        /* Styles Atlas Monde */
        .map-hotspot {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #F97316; /* Orange-500 */
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
            animation: pulse-orange 2s infinite;
            transition: transform 0.3s ease;
            z-index: 20;
        }
        .map-hotspot:hover { transform: scale(1.5); background-color: #4F46E5; z-index: 30; }
        
        @keyframes pulse-orange {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
        }

        /* --- Styles pour le Slider Avant/Après (Comparaison) --- */
        .comparison-slider {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            cursor: ew-resize;
            background-color: #111827; /* Fond sombre pour le letterbox */
            
            /* CORRECTION VOILE BLEU : Empêche la sélection de texte */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: none; /* Empêche le scroll vertical sur mobile pendant le drag */
        }

        .comparison-slider img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* CORRECTION ZOOM : Affiche l'image en entier sans couper */
            object-position: center;
            pointer-events: none; /* Empêche le drag natif de l'image */
        }

        .comparison-slider .after-image {
            z-index: 1;
        }

        .comparison-slider .before-image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            overflow: hidden;
            z-index: 2;
            border-right: 3px solid white;
            box-shadow: 5px 0 15px -5px rgba(0,0,0,0.4);
            background-color: #111827; /* Important pour masquer l'image du dessous */
        }

        /* CORRECTION IMAGE STATIQUE */
        /* L'image à l'intérieur du conteneur masqué doit avoir la taille du conteneur parent (le slider) */
        /* width: 100vw fonctionne car le modal est plein écran. Cela empêche l'image de s'écraser. */
        .comparison-slider .before-image-container img {
            width: 100vw; 
            height: 100%;
            max-width: none;
        }

        .comparison-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 44px;
            background-color: white;
            border-radius: 50%;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4F46E5;
            font-size: 1.2rem;
            pointer-events: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        
        /* Boutons Scénarios Actifs */
        .btn-scenario.active {
            background-color: #F97316; /* Orange */
            color: white;
            border-color: #F97316;
            box-shadow: 0 0 10px rgba(249, 115, 22, 0.5);
        }
        /* --------------------------------------------------------- */

        /* Responsive Timeline */
        @media (max-width: 768px) {
            .timeline-line { left: 20px; }
            .timeline-point { left: 20px; }
            .timeline-card { width: 100%; padding-left: 50px !important; padding-right: 0 !important; text-align: left !important; left: 0 !important; margin-bottom: 2rem; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- OVERLAY FACT (LE SAVIEZ-VOUS) -->
    <div id="fact-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden z-[70] flex items-center justify-center p-6 fade-in">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full text-center shadow-2xl relative border-t-8 border-orange-500">
            <div class="mx-auto w-16 h-16 bg-orange-100 text-orange-500 rounded-full flex items-center justify-center mb-4 text-3xl">
                <i class="fas fa-info"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4 title-font">Le Saviez-vous ?</h3>
            <p id="fact-text" class="text-gray-600 mb-8 text-lg leading-relaxed"></p>
            <button id="close-fact-btn" class="w-full bg-orange-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-orange-600 transition transform hover:scale-[1.02] shadow-md flex items-center justify-center gap-2">
                Suivant <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- MODAL RÉVÉLATION SCÉNARIO (IMAGE) -->
    <div id="scenario-image-overlay" class="fixed inset-0 bg-black z-[100] hidden flex flex-col items-center justify-center fade-in">
        <div class="absolute top-0 w-full bg-gradient-to-b from-black/80 to-transparent text-white text-center p-6 z-10">
            <h2 class="text-2xl md:text-3xl font-bold tracking-widest uppercase title-font shadow-black drop-shadow-lg">Votre Vision se dessine...</h2>
        </div>
        
        <div class="w-full h-full flex items-center justify-center p-4 bg-black">
            <img id="scenario-reveal-img" src="" 
                 onerror="this.onerror=null; this.src=this.src.replace('.png', '.jpg');" 
                 alt="Illustration Scénario" 
                 class="max-w-full max-h-screen object-contain shadow-2xl">
        </div>

        <button id="skip-scenario-btn" onclick="closeScenarioImage()" class="absolute bottom-10 bg-white text-indigo-900 hover:bg-orange-500 hover:text-white font-bold py-3 px-8 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.3)] transition-all transform hover:scale-105 hidden flex items-center gap-3 z-50 text-lg border-2 border-indigo-900">
            <span>Découvrir le résultat</span> <i class="fas fa-arrow-right"></i>
        </button>
    </div>

    <!-- MODAL SLIDER ATRIUM (AVANT/APRÈS) -->
    <div id="atrium-modal" class="fixed inset-0 bg-black z-[95] hidden flex flex-col fade-in">
        <!-- Header -->
        <div class="absolute top-0 left-0 right-0 p-4 z-50 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
            <div class="pointer-events-auto text-white drop-shadow-md">
                <h2 class="text-xl md:text-2xl font-bold title-font"><i class="fas fa-exchange-alt mr-2 text-orange-500"></i>L'ATRIUM 2050</h2>
                <p class="text-xs md:text-sm opacity-90">Comparaison : 2023 vs Vision Future</p>
            </div>
            <button onclick="closeAtrium()" class="pointer-events-auto bg-white/20 hover:bg-white/40 backdrop-blur-sm text-white rounded-full w-10 h-10 flex items-center justify-center transition-colors shadow-lg">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Slider Area -->
        <div class="flex-grow relative w-full h-full bg-gray-900">
            <div id="atrium-comparison-slider" class="comparison-slider">
                <!-- Image "Après" (2050) - Image de fond -->
                <img id="atrium-after-img" src="" alt="Atrium 2050 (Après)" class="after-image">
                
                <!-- Image "Avant" (2023) - Dans le conteneur redimensionnable -->
                <div class="before-image-container" style="width: 50%;">
                    <!-- Image de base (Format PNG) -->
                    <img id="atrium-before-img" src="Atrium 2023.png" onerror="this.onerror=null; this.src='Atrium 2023.jpg';" alt="Atrium 2023 (Avant)">
                </div>

                <!-- Handle -->
                <div class="comparison-handle" style="left: 50%;">
                    <i class="fas fa-arrows-alt-h"></i>
                </div>
            </div>
        </div>

        <!-- Footer Controls -->
        <div class="bg-black/90 text-white p-4 pb-8 flex flex-col items-center gap-3 z-50 border-t border-gray-800">
            <!-- Zone de texte descriptive ajoutée -->
            <div id="atrium-scenario-label" class="text-sm md:text-base text-center mb-2 px-4 min-h-[1.5em] transition-all duration-300">
                <span class="text-gray-400 italic">Sélectionnez un scénario ci-dessous...</span>
            </div>

            <div class="flex flex-wrap justify-center gap-2">
                <button onclick="setAtriumScenario('S1')" id="btn-s1" class="btn-scenario px-3 py-1.5 rounded border border-white/30 hover:bg-white/10 text-xs font-bold transition-all">S1</button>
                <button onclick="setAtriumScenario('S2')" id="btn-s2" class="btn-scenario px-3 py-1.5 rounded border border-white/30 hover:bg-white/10 text-xs font-bold transition-all">S2</button>
                <button onclick="setAtriumScenario('S3')" id="btn-s3" class="btn-scenario px-3 py-1.5 rounded border border-white/30 hover:bg-white/10 text-xs font-bold transition-all">S3</button>
                <button onclick="setAtriumScenario('S4')" id="btn-s4" class="btn-scenario px-3 py-1.5 rounded border border-white/30 hover:bg-white/10 text-xs font-bold transition-all">S4</button>
                <button onclick="setAtriumScenario('S5')" id="btn-s5" class="btn-scenario px-3 py-1.5 rounded border border-white/30 hover:bg-white/10 text-xs font-bold transition-all">S5</button>
                <button onclick="setAtriumScenario('S6')" id="btn-s6" class="btn-scenario px-3 py-1.5 rounded border border-white/30 hover:bg-white/10 text-xs font-bold transition-all">S6</button>
            </div>
        </div>
    </div>

    <!-- MODAL ATLAS MONDE -->
    <div id="atlas-modal" class="fixed inset-0 bg-indigo-900 bg-opacity-95 hidden z-[80] flex flex-col items-center justify-center p-4 fade-in">
        <div class="absolute top-4 right-4 z-50">
             <button onclick="closeAtlas()" class="text-white hover:text-orange-400 transition-colors text-3xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="text-center mb-6 text-white z-10">
            <h2 class="text-3xl font-extrabold title-font tracking-wider"><i class="fas fa-globe-americas mr-2 text-orange-500"></i>ATLAS UNIVERSITAIRE</h2>
            <p class="text-indigo-200 text-sm">Explorez les dynamiques mondiales de l'enseignement supérieur</p>
        </div>

        <!-- Container Carte -->
        <div class="relative w-full max-w-5xl aspect-video bg-indigo-800 rounded-xl overflow-hidden shadow-2xl border border-indigo-600 group">
            
            <!-- Carte Image -->
            <img src="1024px-BlankMap-World.svg.png" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/World_map_blank_without_borders.svg/1024px-World_map_blank_without_borders.svg.png'" alt="Carte du Monde" class="absolute inset-0 w-full h-full object-fill opacity-90 group-hover:opacity-100 transition-opacity duration-500">
            
            <!-- Points chauds -->
            <div onclick="showAtlasFact('usa')" class="map-hotspot" style="top: 33%; left: 24%;" title="États-Unis"></div>
            <div onclick="showAtlasFact('europe')" class="map-hotspot" style="top: 27%; left: 49.5%;" title="Europe"></div>
            <div onclick="showAtlasFact('uk')" class="map-hotspot" style="top: 23%; left: 47%;" title="Royaume-Uni"></div>
            <div onclick="showAtlasFact('china')" class="map-hotspot" style="top: 32%; left: 78%;" title="Chine"></div>
            <div onclick="showAtlasFact('india')" class="map-hotspot" style="top: 40%; left: 69%;" title="Inde"></div>
            <div onclick="showAtlasFact('philippines')" class="map-hotspot" style="top: 48%; left: 83%;" title="Philippines"></div>
            
        </div>
        <p class="text-indigo-400 text-xs mt-4 italic">Cliquez sur les points oranges pour découvrir les données clés.</p>
    </div>

    <!-- Info Box FULL SCREEN OVERLAY pour l'Atlas -->
    <div id="atlas-info-box" class="fixed inset-0 bg-white z-[85] hidden flex flex-col animate-fade-in">
        <!-- Header Box -->
        <div class="bg-indigo-900 text-white p-6 flex justify-between items-center shadow-md flex-shrink-0">
            <h4 id="atlas-country" class="text-2xl font-bold uppercase tracking-wide title-font">PAYS</h4>
            <button onclick="hideAtlasFact()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-full transition-colors flex items-center gap-2">
                <span>Fermer</span> <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Content Scrollable -->
        <div class="flex-grow overflow-y-auto p-8 md:p-12 bg-gray-50">
            <div id="atlas-content" class="max-w-4xl mx-auto text-gray-800 text-lg leading-relaxed space-y-6">
                <!-- Contenu dynamique -->
            </div>
        </div>
    </div>

    <!-- MODAL POPUP FOR SCENARIO DETAILS -->
    <div id="scenario-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden relative transform transition-all scale-100">
            <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center transition-colors">
                <i class="fas fa-times"></i>
            </button>
            <div id="modal-header" class="p-6 pb-4 border-b">
                <div class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-1" id="modal-id">SCÉNARIO</div>
                <h3 id="modal-title" class="text-2xl font-bold title-font text-gray-800 leading-tight">Titre</h3>
                <p id="modal-subtitle" class="text-sm italic text-gray-600 mt-1">Sous-titre</p>
            </div>
            <div class="p-6 pt-4 bg-gray-50">
                <p id="modal-desc" class="text-sm text-gray-700 leading-relaxed text-justify">Description...</p>
            </div>
        </div>
    </div>

    <!-- MODAL PDF VIEWER -->
    <div id="pdf-modal" class="fixed inset-0 bg-black bg-opacity-95 hidden z-[60] flex items-center justify-center p-0 md:p-8 fade-in">
        <div class="bg-white md:rounded-xl shadow-2xl w-full h-full md:h-[90vh] md:max-w-7xl flex flex-col overflow-hidden relative">
            <div class="bg-gray-900 text-white p-3 md:p-4 flex flex-col md:flex-row justify-between items-center shadow-md z-10 gap-2 shrink-0">
                <div class="flex items-center gap-4 overflow-hidden w-full md:w-auto justify-between md:justify-start">
                    <h3 id="pdf-title" class="text-lg font-bold truncate"><i class="fas fa-book-open mr-2"></i> Planches</h3>
                    <span id="page-indicator" class="text-sm bg-gray-700 px-3 py-1 rounded-full whitespace-nowrap">Page 1 / 4</span>
                </div>
                <div class="flex items-center gap-3 w-full md:w-auto justify-center">
                    <button onclick="prevPdf()" id="btn-prev" class="bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white px-4 py-2 rounded transition-colors shadow-sm flex items-center gap-2">
                        <i class="fas fa-chevron-left"></i> <span class="hidden md:inline">Précédent</span>
                    </button>
                    <button onclick="nextPdf()" id="btn-next" class="bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white px-4 py-2 rounded transition-colors shadow-sm flex items-center gap-2">
                        <span class="hidden md:inline">Suivant</span> <i class="fas fa-chevron-right"></i>
                    </button>
                    <button onclick="closePdfModal()" class="text-white hover:text-red-400 transition-colors text-2xl px-2 ml-auto md:ml-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div id="pdf-container" class="flex-grow bg-gray-200 relative w-full h-full overflow-y-auto" style="-webkit-overflow-scrolling: touch;">
                <!-- LE CONTENU SERA INJECTÉ ICI PAR JS -->
            </div>
        </div>
    </div>

    <!-- MODAL TIMELINE INTERACTIVE -->
    <div id="timeline-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[65] flex items-center justify-center p-2 md:p-6 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-full flex flex-col overflow-hidden relative">
            <div class="bg-indigo-900 text-white p-6 flex justify-between items-center shadow-md z-10">
                <div>
                    <h3 class="text-2xl font-bold title-font"><i class="fas fa-history mr-2 text-orange-400"></i> Histoire du Campus</h3>
                    <p class="text-xs text-indigo-200 mt-1">De la médecine médiévale à la ville de demain</p>
                </div>
                <button onclick="closeTimeline()" class="text-white hover:text-red-400 transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-6 bg-gray-50 relative" id="timeline-container">
                <div class="timeline-line"></div>
                <div id="timeline-content" class="py-10"></div>
                <div class="text-center mt-10 mb-4">
                    <p class="text-gray-400 italic text-sm">Fin de la chronologie historique</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL STATS -->
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[75] flex items-center justify-center p-2 md:p-6 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-full md:h-auto md:max-h-[90vh] flex flex-col overflow-hidden relative">
            <div class="bg-indigo-900 text-white p-4 md:p-6 flex justify-between items-center shadow-md z-10 shrink-0">
                <div>
                    <h3 class="text-xl md:text-2xl font-bold title-font"><i class="fas fa-chart-pie mr-2 text-orange-400"></i> Observatoire des Données</h3>
                    <p class="text-xs text-indigo-200 mt-1">L'impact universitaire en chiffres</p>
                </div>
                <button onclick="closeStats()" class="text-white hover:text-red-400 transition-colors text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-grow flex flex-col bg-gray-50 overflow-y-auto">
                <div class="p-4 md:p-8 flex flex-col items-center justify-center min-h-[300px] md:min-h-[400px]">
                    <div class="w-full max-w-2xl bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative">
                        <h4 id="stat-title" class="text-center font-bold text-gray-800 text-lg mb-2 title-font">Titre du Graphique</h4>
                        <p id="stat-desc" class="text-center text-sm text-gray-500 mb-4 px-4 italic">Description...</p>
                        <div class="relative h-64 md:h-80 w-full">
                            <canvas id="statsCanvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-white border-t border-gray-200 p-4 shrink-0">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-2">Choisir une visualisation :</p>
                    <div class="flex gap-4 overflow-x-auto pb-2 snap-x px-2" style="-webkit-overflow-scrolling: touch;">
                        <button onclick="renderStat(0)" class="snap-start shrink-0 w-40 p-3 rounded-lg border-2 border-transparent hover:border-indigo-500 bg-gray-50 hover:bg-indigo-50 transition-all text-left group focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-users text-orange-500 bg-orange-100 p-2 rounded-full"></i>
                                <span class="text-xs font-bold text-gray-700 group-hover:text-indigo-700">Poids Démographique</span>
                            </div>
                            <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-orange-500 w-1/4"></div></div>
                        </button>
                        <button onclick="renderStat(1)" class="snap-start shrink-0 w-40 p-3 rounded-lg border-2 border-transparent hover:border-indigo-500 bg-gray-50 hover:bg-indigo-50 transition-all text-left group focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-map-marked-alt text-blue-500 bg-blue-100 p-2 rounded-full"></i>
                                <span class="text-xs font-bold text-gray-700 group-hover:text-indigo-700">Fragmentation Territoriale</span>
                            </div>
                             <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-blue-500 w-2/3"></div></div>
                        </button>
                        <button onclick="renderStat(2)" class="snap-start shrink-0 w-40 p-3 rounded-lg border-2 border-transparent hover:border-indigo-500 bg-gray-50 hover:bg-indigo-50 transition-all text-left group focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="fas fa-balance-scale text-purple-500 bg-purple-100 p-2 rounded-full"></i>
                                <span class="text-xs font-bold text-gray-700 group-hover:text-indigo-700">Inégalités de Moyens</span>
                            </div>
                             <div class="h-1 w-full bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-purple-500 w-1/2"></div></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CGU -->
    <div id="cgu-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[90] flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl h-[80vh] flex flex-col overflow-hidden relative">
            <div class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md z-10 flex-shrink-0">
                <h3 class="text-lg font-bold"><i class="fas fa-file-contract mr-2"></i> Conditions Générales d'Utilisation</h3>
                <button onclick="closeCgu()" class="text-white hover:text-red-400 transition-colors text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 text-gray-700 text-sm leading-relaxed" style="-webkit-overflow-scrolling: touch;">
                <h4 class="text-xl font-bold text-indigo-900 mb-4">1. Objet des CGU</h4>
                <p class="mb-4">Les présentes Conditions Générales d'Utilisation (ci-après « CGU ») ont pour objet de définir les modalités d'accès et d'utilisation du site...</p>
                <p class="italic text-gray-400">(Contenu complet conservé)</p>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="bg-white text-indigo-900 shadow-md z-10">
        <div class="w-full px-4 py-3 flex justify-between items-center relative">
            <div class="flex items-center justify-start w-1/4 md:w-1/3">
                <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center font-bold text-white text-xl shadow-sm">U</div>
            </div>
            <div class="flex flex-col items-center justify-center text-center w-1/2 md:w-1/3 md:absolute md:left-1/2 md:transform md:-translate-x-1/2">
                <h1 class="text-sm md:text-2xl font-extrabold tracking-wider uppercase leading-tight text-indigo-900">L'UNIVERSITÉ DANS LA VILLE</h1>
                <span class="text-[10px] md:text-xs font-semibold tracking-widest opacity-70 uppercase hidden sm:block text-indigo-800">Université & Ville de Demain</span>
            </div>
            <div class="flex items-center justify-end gap-2 md:gap-3 w-1/4 md:w-1/3">
                <img src="PROJET_NOIR.png" onerror="this.src='https://via.placeholder.com/150x50?text=PROJET'" alt="Master" class="h-3 sm:h-8 md:h-12 w-auto object-contain">
                <div class="h-4 sm:h-6 md:h-8 w-px bg-gray-300 hidden sm:block"></div>
                <img src="UMPV_NOIR.png" onerror="this.src='https://via.placeholder.com/150x50?text=UMPV'" alt="UMPV" class="h-3 sm:h-8 md:h-12 w-auto object-contain">
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col items-center justify-center" id="game-container">
        
        <!-- INTRO SCREEN -->
        <div id="intro-screen" class="max-w-2xl w-full bg-white rounded-2xl shadow-xl overflow-hidden fade-in">
            <div class="bg-indigo-600 h-2 w-full"></div>
            <div class="p-8 text-center">
                <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Quelle est votre vision de l'Université ?</h2>
                <p class="text-gray-600 mb-6 text-lg">
                    Bienvenue, futur(e) urbaniste. <br><br>
                    L'université est à la croisée des chemins. Entre contraintes budgétaires, révolution numérique et intégration urbaine, 
                    <strong>quel visage aura l'université de Montpellier en 2050 ?</strong>
                </p>
                <div class="bg-indigo-50 p-4 rounded-lg mb-8 text-sm text-indigo-800 text-left">
                    <p class="font-bold mb-2">Instructions :</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Vous allez incarner un acteur clé (Maire, Expert ou Étudiant).</li>
                        <li>Vous ferez face à <strong>7 dilemmes stratégiques</strong>.</li>
                        <li>Vos choix détermineront l'un des <strong>6 Scénarios Futurs</strong>.</li>
                    </ul>
                </div>
                <button onclick="goToPersonaSelection()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 shadow-md transform hover:scale-105">
                    Commencer l'expérience
                </button>
            </div>
        </div>

        <!-- PERSONA SELECTION SCREEN -->
        <div id="persona-screen" class="hidden max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden fade-in">
            <!-- (Contenu persona identique) -->
            <div class="bg-indigo-900 h-2 w-full"></div>
            <div class="p-8 text-center">
                <h2 class="text-2xl font-extrabold text-gray-800 mb-2">Choisissez votre rôle</h2>
                <p class="text-gray-600 mb-8 text-sm">Qui êtes-vous pour mener ce diagnostic ?</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 text-left">
                    
                    <!-- Politique -->
                    <div onclick="selectPersona('politique')" id="persona-politique" class="persona-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all group">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-lg"><i class="fas fa-user-tie"></i></div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-800">Michaël D.</h4>
                                <span class="text-xs text-blue-600 font-semibold uppercase">Maire</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 italic">"L'université doit être une couture urbaine, ouverte sur la ville."</p>
                    </div>

                    <!-- Expert -->
                    <div onclick="selectPersona('expert')" id="persona-expert" class="persona-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all group">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-lg"><i class="fas fa-drafting-compass"></i></div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-800">Antoine G-D.</h4>
                                <span class="text-xs text-purple-600 font-semibold uppercase">Architecte</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 italic">"Respecter le patrimoine du XXe tout en densifiant intelligemment."</p>
                    </div>

                    <!-- Étudiante -->
                    <div onclick="selectPersona('etudiante')" id="persona-etudiante" class="persona-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all group">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-lg"><i class="fas fa-user-graduate"></i></div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-800">Sarah</h4>
                                <span class="text-xs text-pink-600 font-semibold uppercase">L3 Arts</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 italic">"On a besoin de vrais lieux de vie sociale, pas juste des couloirs."</p>
                    </div>

                    <!-- Étudiant -->
                    <div onclick="selectPersona('etudiant')" id="persona-etudiant" class="persona-card border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:shadow-lg transition-all group">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-lg"><i class="fas fa-laptop-code"></i></div>
                            <div>
                                <h4 class="font-bold text-sm text-gray-800">Mehdi</h4>
                                <span class="text-xs text-green-600 font-semibold uppercase">Master Urba</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 italic">"Le coût du logement et la mobilité sont mes priorités."</p>
                    </div>

                </div>

                <button onclick="startGame()" id="start-btn" disabled class="bg-gray-300 text-white font-bold py-3 px-8 rounded-full text-lg transition duration-300 shadow-md cursor-not-allowed w-full md:w-auto">
                    Choisir un personnage
                </button>
            </div>
        </div>

        <!-- QUESTIONS -->
        <div id="question-screen" class="hidden max-w-3xl w-full fade-in">
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm font-semibold text-gray-500 uppercase">Enjeu <span id="current-question-num">1</span>/7</span>
                <div class="w-1/3 bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
                <div class="flex items-center mb-6">
                    <span id="enjeu-badge" class="bg-indigo-100 text-indigo-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded uppercase">Économique</span>
                    <h2 id="question-text" class="text-2xl font-bold text-gray-800">Question</h2>
                </div>
                <p id="question-context" class="text-gray-600 mb-8 italic text-sm border-l-4 border-orange-400 pl-4">Contexte...</p>
                <div id="answers-container" class="grid gap-4 md:grid-cols-1"></div>
            </div>
        </div>

        <!-- RESULT -->
        <div id="result-screen" class="hidden max-w-4xl w-full fade-in">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div id="result-header" class="bg-indigo-900 p-8 text-white text-center relative">
                    <p class="uppercase tracking-widest text-xs opacity-70 mb-2">Votre vision dominante est</p>
                    <h2 id="scenario-title" class="text-4xl font-extrabold mb-2 title-font text-orange-400">TITRE</h2>
                    <h3 id="scenario-subtitle" class="text-xl font-light italic">Sous-titre</h3>
                    <div class="absolute top-4 right-4 text-6xl opacity-20"><i class="fas fa-city"></i></div>
                    
                    <!-- NEW: Zone pour les statistiques Firebase -->
                    <p id="resultat-texte" class="mt-4 text-sm font-bold text-orange-300 bg-indigo-800 bg-opacity-50 inline-block px-4 py-2 rounded-lg">Chargement des données communautaires...</p>
                </div>

                <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <!-- SECTION PERSONNAGE FEEDBACK -->
                        <div id="persona-feedback" class="bg-indigo-50 border-l-4 border-indigo-500 p-4 mb-6 rounded-r">
                            <h4 id="persona-feedback-title" class="font-bold text-indigo-900 text-sm mb-1">Le mot de l'expert</h4>
                            <p id="persona-feedback-text" class="text-sm text-indigo-800 italic">Analysis...</p>
                        </div>

                        <h4 class="font-bold text-gray-800 mb-4 border-b pb-2">Description du Scénario</h4>
                        <p id="scenario-desc" class="text-gray-600 leading-relaxed text-justify text-sm mb-6">Desc...</p>
                        <h4 class="font-bold text-gray-800 mb-4 border-b pb-2">Enjeux Clés</h4>
                        <ul id="scenario-issues" class="text-sm text-gray-700 space-y-2 list-disc pl-4"></ul>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-4 flex flex-col justify-center">
                        <h4 class="font-bold text-gray-800 mb-2 text-center">Votre profil de Diagnostic</h4>
                        <canvas id="radarChart"></canvas>

                        <!-- AJOUT : BOUTON REVOIR L'IMAGE + IMMERSION -->
                        <div class="mt-6 border-t pt-4 space-y-3">
                            <!-- Bouton Revoir Image -->
                             <button onclick="reopenScenarioImage()" class="w-full bg-orange-100 hover:bg-orange-200 text-orange-700 text-sm font-bold py-3 px-4 rounded transition duration-200 flex items-center justify-center gap-2 border border-orange-200">
                                <i class="fas fa-eye text-lg"></i> Revoir l'illustration
                            </button>

                            <h4 class="font-bold text-indigo-900 mb-2 text-center text-sm pt-2">Immersion Future</h4>
                            <button onclick="revealStory()" id="reveal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-3 px-4 rounded transition duration-200 flex items-center justify-center gap-2">
                                <i class="fas fa-book-open text-lg"></i> Découvrir le Récit
                            </button>
                            <div id="story-display" class="hidden mt-4 text-sm text-gray-700 bg-white p-4 rounded border border-gray-200 shadow-inner">
                                <p id="story-text" class="leading-relaxed italic text-gray-800 font-serif mb-4"></p>
                                <div class="border-t pt-3 flex flex-col items-center justify-center">
                                    <div id="speaking-indicator" class="hidden mb-2">
                                        <div class="speaking-animation"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
                                        <p class="text-center text-xs text-indigo-600 mt-1 font-bold">Narration en cours...</p>
                                    </div>
                                    <button onclick="playAudio()" id="play-audio-btn" class="text-indigo-600 hover:text-indigo-800 font-bold py-2 px-4 rounded flex items-center gap-2 transition-colors">
                                        <i class="fas fa-volume-up text-lg"></i> Lire
                                    </button>
                                    <button onclick="stopAudio()" id="stop-audio-btn" class="hidden text-red-500 hover:text-red-700 font-bold py-2 px-4 rounded flex items-center gap-2 transition-colors">
                                        <i class="fas fa-stop-circle text-lg"></i> Arrêter
                                    </button>
                                </div>
                            </div>
                        </div>

                         <!-- NUAGE DE MOTS - MUR DES DOLÉANCES -->
                         <div class="mt-6 border-t pt-4 bg-white rounded-lg p-3 shadow-sm border border-gray-100">
                             <h4 class="font-bold text-indigo-900 mb-3 text-center text-sm"><i class="fas fa-comment-dots text-orange-500 mr-2"></i>Le Mur des Idées</h4>
                             <p class="text-xs text-gray-500 text-center mb-3">Un mot pour l'université de demain ?</p>
                             
                             <div class="flex gap-2 mb-4">
                                 <input type="text" id="user-word" placeholder="Ex: Verte, Inclusive..." class="flex-grow border border-gray-300 rounded-lg px-3 py-2 text-xs focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500">
                                 <button onclick="addWord()" class="bg-indigo-600 text-white rounded-lg px-3 py-2 text-xs font-bold hover:bg-indigo-700 transition">Publier</button>
                             </div>
 
                             <!-- Nuage de mots interactif -->
                             <div id="word-cloud" class="flex flex-wrap justify-center items-center gap-2 min-h-[120px] max-h-[200px] overflow-y-auto p-2 bg-gray-50 rounded-lg border border-gray-100">
                                 <!-- Le contenu sera généré par JS -->
                             </div>
                         </div>

                        <div class="mt-6 flex flex-col gap-3 text-center">
                            <button onclick="restartGame()" class="text-gray-600 hover:text-gray-800 text-sm font-semibold underline">Recommencer</button>
                            <button onclick="showWorks()" class="bg-white border-2 border-indigo-600 text-indigo-600 hover:bg-indigo-600 hover:text-white font-bold py-3 px-6 rounded-full text-sm transition duration-300 shadow-md flex items-center justify-center gap-2">
                                <i class="fas fa-project-diagram"></i> Découvrir nos travaux
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WORKS SCREEN -->
        <div id="works-screen" class="hidden max-w-6xl w-full fade-in">
            <!-- (Contenu identique) -->
            <div class="text-center mb-10">
                <h2 class="text-4xl font-extrabold text-indigo-900 mb-2 title-font">L'EXPOSITION VIRTUELLE</h2>
                <div class="h-1 w-24 bg-orange-500 mx-auto mb-4"></div>
                <p class="text-gray-600 max-w-2xl mx-auto">
                    Planches de recherche et projets urbains réalisés par le Master Projet.
                </p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 px-4">
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover border border-gray-100 group">
                    <div class="h-48 bg-indigo-900 flex items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <i class="fas fa-bullhorn text-6xl text-orange-400 group-hover:scale-110 transition-transform duration-500"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Communication & Scénographie</h3>
                        <p class="text-sm text-gray-500 mb-4">Présentation générale de la démarche, Histoire et Plan de Masse.</p>
                        <div class="space-y-3">
                            <button onclick="openCommsGallery()" class="w-full bg-gray-100 hover:bg-indigo-100 text-indigo-700 font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-images"></i> Voir les planches (PDF)
                            </button>
                            <button onclick="openTimeline()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors">
                                <i class="fas fa-history"></i> Voir la Frise Chronologique
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover border border-gray-100 group border-t-4 border-indigo-600">
                    <div class="h-48 bg-indigo-800 flex items-center justify-center relative overflow-hidden">
                         <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/world-map.png')]"></div>
                         <i class="fas fa-globe-americas text-6xl text-indigo-300 group-hover:text-white group-hover:scale-110 transition-all duration-500"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Contexte International</h3>
                        <p class="text-sm text-gray-500 mb-4">Visualisez les faits marquants de l'enseignement supérieur à travers le monde : frais, mobilités, classements.</p>
                        <button onclick="openAtlas()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-md">
                            <i class="fas fa-map-marked-alt"></i> Ouvrir l'Atlas
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover border border-gray-100 group border-t-4 border-purple-600">
                    <div class="h-48 bg-purple-800 flex items-center justify-center relative overflow-hidden">
                         <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/graphy.png')]"></div>
                         <i class="fas fa-chart-pie text-6xl text-purple-300 group-hover:text-white group-hover:scale-110 transition-all duration-500"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Observatoire Statistique</h3>
                        <p class="text-sm text-gray-500 mb-4">Explorez les chiffres clés : poids démographique des étudiants, fragmentation des campus et inégalités de moyens.</p>
                        <button onclick="openStats()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-md">
                            <i class="fas fa-chart-line"></i> Voir les Stats
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover border border-gray-100 group">
                    <div class="h-48 bg-green-600 flex items-center justify-center relative overflow-hidden">
                        <i class="fas fa-road text-6xl text-white group-hover:scale-110 transition-transform duration-500"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">La Révolution de la Route de Mende</h3>
                        <p class="text-sm text-gray-500 mb-4">Transformation d'une coupure routière en boulevard urbain apaisé. Arrivée du Tram 5, élargissement des trottoirs et pistes cyclables pour relier le campus à la ville.</p>
                        <div class="mt-2 text-xs text-gray-400 italic"><i class="fas fa-check-circle mr-1"></i> Projet en cours</div>
                    </div>
                </div>

                <!-- CARTE MODIFIÉE : ATRIUM AVEC BOUTON PLEIN ÉCRAN (Cliquable entièrement) -->
                <div onclick="openAtrium()" class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover border border-gray-100 group cursor-pointer">
                    <div class="h-48 bg-blue-600 flex items-center justify-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition-colors"></div>
                        <i class="fas fa-archway text-6xl text-white group-hover:scale-110 transition-transform duration-500 z-10"></i>
                        <!-- Image de fond floue pour le style (Utilise la nouvelle image) -->
                        <img src="Atrium 2023.png" onerror="this.src='Atrium 2023.jpg'" class="absolute inset-0 w-full h-full object-cover opacity-30" alt="">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">L'Atrium : Une Place Publique (2023 vs 2050)</h3>
                        <p class="text-sm text-gray-500 mb-4">
                            Découvrez la métamorphose de l'Atrium à travers un slider interactif Avant/Après. Cliquez pour voir l'évolution en détail.
                        </p>
                        
                        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-md">
                            <i class="fas fa-expand"></i> Ouvrir le Comparateur
                        </button>

                        <div class="mt-2 text-xs text-gray-400 italic"><i class="fas fa-check-circle mr-1"></i> Visualisation immersive</div>
                    </div>
                </div>
            </div>
            <div class="mt-12 text-center">
                <button onclick="closeWorks()" class="text-indigo-600 hover:text-orange-500 font-semibold flex items-center justify-center gap-2 mx-auto transition-colors">
                    <i class="fas fa-arrow-left"></i> Retour aux résultats
                </button>
            </div>
        </div>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-4 mt-auto">
        <div class="container mx-auto px-4 text-center text-xs flex flex-col md:flex-row justify-center items-center gap-2">
            <p>Master PROJET [PROJET d'aménagement et prospective territoriale]</p>
            <span class="hidden md:inline">|</span>
            <button onclick="openCgu()" class="hover:text-white underline transition-colors">Mentions Légales & CGU</button>
        </div>
    </footer>

    <script>
        // NAVIGATION ET LOGIQUE PERSONNAGES
        const introScreen = document.getElementById('intro-screen');
        const personaScreen = document.getElementById('persona-screen');
        const questionScreen = document.getElementById('question-screen');
        const resultScreen = document.getElementById('result-screen');
        const worksScreen = document.getElementById('works-screen');
        const factOverlay = document.getElementById('fact-overlay');
        const factText = document.getElementById('fact-text');
        const closeFactBtn = document.getElementById('close-fact-btn');

        // GESTION IMAGE OVERLAY
        const scenarioImageOverlay = document.getElementById('scenario-image-overlay');
        const scenarioRevealImg = document.getElementById('scenario-reveal-img');
        const skipScenarioBtn = document.getElementById('skip-scenario-btn');
        let imageTimer = null;

        function goToPersonaSelection() {
            introScreen.classList.add('hidden');
            personaScreen.classList.remove('hidden');
        }

        const personas = {
            politique: { name: "Michaël Delafosse", role: "Maire / Président Métropole", quote: "L'enjeu est la couture urbaine. L'université ne doit plus être une île, mais un quartier de la ville relié par le tramway gratuit.", focus: "Intégration Urbaine" },
            expert: { name: "Antoine Garcia-Diaz", role: "Architecte Urbaniste", quote: "Le plan guide doit respecter l'histoire de ce campus 'Patrimoine du XXe siècle' tout en permettant sa densification nécessaire.", focus: "Patrimoine & Forme Urbaine" },
            etudiante: { name: "Sarah", role: "Étudiante L3 Arts", quote: "Je passe ma vie ici. On a besoin de vrais lieux de vie sociale, pas juste des couloirs. L'isolement est un vrai problème.", focus: "Vie Sociale & Culturelle" },
            etudiant: { name: "Mehdi", role: "Étudiant Master Urbanisme", quote: "Sans voiture, c'était compliqué, mais heureusement que la ligne 5 est enfin là ! Le coût du logement à côté de la fac reste critique.", focus: "Mobilité & Logement" }
        };

        let currentPersona = null;

        function selectPersona(id) {
            currentPersona = id;
            document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected-persona', 'ring-2', 'ring-indigo-500'));
            document.getElementById('persona-' + id).classList.add('selected-persona', 'ring-2', 'ring-indigo-500');
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
            btn.classList.add('bg-orange-500', 'hover:bg-orange-600', 'cursor-pointer');
            btn.innerHTML = `Valider et Démarrer`;
        }

        function startGame() { 
            if(!currentPersona) return;
            personaScreen.classList.add('hidden'); 
            questionScreen.classList.remove('hidden'); 
            loadQuestion(); 
        }

        // ... SCÉNARIOS, QUESTIONS, GRAPHIQUES ...
        const scenarioStories = {
            s1: "Ce matin, le tramway m'a déposé au pied des nouveaux bâtiments rénovés. L'université n'a pas changé de visage du tout au tout, mais elle respire mieux. On sent une transition douce, rassurante. Ici, pas de révolution technologique brutale, mais une continuité apaisée où l'on prend le temps de vivre et d'étudier ensemble, solidement ancrés dans notre quartier.",
            s2: "Badge scanné, accès autorisé. En entrant dans le Hub, je croise autant de chercheurs que d'entrepreneurs. L'atmosphère est électrique, tournée vers la performance. Ici, chaque idée doit trouver son marché. C'est stimulant d'être au cœur de l'innovation, même si parfois, j'ai l'impression que la rentabilité compte plus que la connaissance pure.",
            s3: "8h59, je me connecte. Mon salon devient mon amphi. Sur l'écran, des visages du monde entier. C'est une liberté incroyable de pouvoir étudier d'où l'on veut, sans contrainte physique. Pourtant, quand je déconnecte, le silence de l'appartement me rappelle que la vie étudiante, c'était aussi les cafés et les couloirs bruyants qui ont disparu.",
            s4: "Aujourd'hui, mon séminaire est au musée Fabre, et demain, je travaillerai dans un espace de co-working aux Arceaux. L'université a fait tomber ses murs. La ville entière est devenue ma salle de classe. C'est passionnant de se mêler à la population, même si parfois, on aimerait avoir un vrai campus pour se retrouver entre nous.",
            s5: "Mon tuteur IA a réorganisé mon programme ce matin après avoir analysé mon sommeil. Le contenu s'adapte exactement à ce que je ne comprends pas. C'est une efficacité pédagogique absolue. On ne perd plus de temps. Mais dans ce monde parfait piloté par les algorithmes, je cherche parfois la place pour l'imprévu et l'erreur humaine.",
            s6: "Cela fait une semaine que je n'ai pas quitté l'enceinte du campus. Et pourquoi sortir ? J'ai mon studio, ma salle de sport, mon cinéma et mes cours ici. C'est une ville parfaite dans la ville, ultra-sécurisée et pratique. On vit dans un cocon privilégié, efficace, peut-être un peu trop coupé des réalités extérieures."
        };

        const scenarios = {
            s1: { id: "S1", title: "Rien ne change / La Continuité", subtitle: "Le changement c'est pas maintenant", description: "Ce scénario imagine une évolution dans la continuité. L'université reste un acteur fort du territoire, mais sans révolution. Elle poursuit son ouverture progressive sur la ville, développe des liens avec les quartiers voisins, et améliore les connexions en mobilité douce.", issues: ["Financement des infrastructures", "Massification des étudiants", "Étalement urbain et ZAN", "Mobilité douce"], color: "#60A5FA" },
            s2: { id: "S2", title: "Le Hub : Université-Entreprise", subtitle: "L'efficacité et l'innovation avant tout", description: "L'université se transforme en plateforme économique et technologique. Laboratoires, incubateurs, start-ups et multinationales se mêlent. La logique du partenariat public-privé domine.", issues: ["Partenariat Public/Privé", "Marchandisation du savoir", "Coût de l'enseignement", "Innovation et Start-ups"], color: "#F59E0B" },
            s3: { id: "S3", title: "L'Université Sans Murs", subtitle: "Le tout numérique", description: "Le numérique prend le dessus. Les cours sont entièrement en ligne, les échanges se font à distance, et les bâtiments physiques perdent leur fonction centrale.", issues: ["Requalification des bâtiments vides", "Isolement social", "Transformation du métier d'enseignant", "Fracture numérique"], color: "#A78BFA" },
            s4: { id: "S4", title: "L'Université Dissoute", subtitle: "La ville est le campus", description: "L'université et la ville se confondent. Il n'existe plus de campus clairement identifiable : les espaces d'enseignement se dispersent dans le tissu urbain (cafés, bibliothèques municipales, tiers-lieux).", issues: ["Disparition du campus physique", "Mixité fonctionnelle extrême", "Gestion d'un réseau éparpillé", "Lien habitants-étudiants"], color: "#10B981" },
            s5: { id: "S5", title: "L'Université Augmentée par l'IA", subtitle: "L'intelligence artificielle au cœur", description: "L'IA transforme en profondeur les façons d'apprendre et de gérer les lieux. Assistants numériques personnalisés, contenus adaptatifs, dépassement des limites géographiques.", issues: ["Éthique et Copyright", "Transformation radicale de l'emploi", "Dépendance technologique", "Obsolescence des méthodes classiques"], color: "#EC4899" },
            s6: { id: "S6", title: "La Ville dans la Ville", subtitle: "Le Campus Urbain Autonome", description: "L'université devient une ville dans la ville, où tout est concentré : logements, services, commerces, santé, culture. C'est un espace autonome, hyper-efficace.", issues: ["Mixité fonctionnelle sur site unique", "Gouvernance du foncier", "Autarcie", "Densification"], color: "#EF4444" }
        };

        const questions = [
            { theme: "Spatial & Foncier", text: "Face au manque de place et à l'objectif ZAN (Zéro Artificialisation Nette), quelle est votre stratégie pour les nouveaux bâtiments ?", context: "Les campus sont saturés et l'étalement urbain n'est plus possible.", didYouKnow: "Le campus Paul Valéry, labellisé 'Patrimoine du XXe siècle', était prévu pour 8 500 étudiants à sa construction. Il en accueille aujourd'hui plus de 22 000, créant une véritable saturation spatiale.", options: [{ text: "On densifie au maximum sur le site actuel pour tout avoir sur place (logements, commerces, cours).", impact: "s6" }, { text: "On n'a plus besoin de construire : on bascule massivement les cours en ligne.", impact: "s3" }, { text: "On loue ou rachète des locaux éparpillés dans toute la ville pour s'intégrer aux quartiers.", impact: "s4" }, { text: "On rénove doucement l'existant en améliorant les espaces verts et les pistes cyclables.", impact: "s1" }] },
            { theme: "Économique & Gouvernance", text: "Le budget de l'État stagne. Comment financez-vous les nouveaux équipements de pointe ?", context: "L'université doit trouver des ressources pour rester compétitive.", didYouKnow: "Le budget de l'Atrium s'élève à 32 millions d'euros HT (pour 57 M€ TTC). Ce Learning Center de 15 000 m² a nécessité des financements croisés entre l'État, la Région et la Métropole.", options: [{ text: "Partenariats massifs avec le privé : les entreprises installent leurs R&D sur le campus.", impact: "s2" }, { text: "On optimise les coûts de gestion grâce à l'IA et on réduit le personnel administratif.", impact: "s5" }, { text: "On loue nos espaces (amphithéâtres, terrains) à la ville et aux associations locales.", impact: "s4" }, { text: "On fait avec les moyens du bord, en priorisant la maintenance de base.", impact: "s1" }] },
            { theme: "Lien Social", text: "Les étudiants se plaignent d'isolement. Quelle est votre réponse architecturale ?", context: "La vie étudiante ne se résume pas aux cours.", didYouKnow: "Pour lutter contre l'isolement, l'Atrium a été conçu explicitement comme une 'place publique du savoir', ouverte aux habitants, et non plus comme une simple bibliothèque fermée.", options: [{ text: "Créer un immense centre de vie (type Atrium) avec cinéma, santé et loisirs au cœur du campus.", impact: "s6" }, { text: "Créer un métavers universitaire pour qu'ils socialisent depuis chez eux.", impact: "s3" }, { text: "Encourager la vie dans les cafés du centre-ville plutôt que sur un campus ghetto.", impact: "s4" }, { text: "Développer des incubateurs où étudiants et entrepreneurs travaillent ensemble.", impact: "s2" }] },
            { theme: "Technologie", text: "L'Intelligence Artificielle bouleverse l'enseignement. Votre réaction ?", context: "ChatGPT et consorts changent la donne pédagogique.", didYouKnow: "Depuis 2020, l'usage des outils numériques a explosé. Le diagnostic montre cependant que le 'tout distanciel' affaiblit le lien social, un enjeu majeur pour 88% des étudiants interrogés.", options: [{ text: "Chaque étudiant reçoit un tuteur IA personnalisé. Les profs deviennent des coachs.", impact: "s5" }, { text: "L'IA sert surtout à optimiser la recherche et les brevets industriels.", impact: "s2" }, { text: "L'IA permet de faire cours sans jamais venir sur le campus.", impact: "s3" }, { text: "On l'intègre doucement comme outil, sans changer la structure des cours magistraux.", impact: "s1" }] },
            { theme: "Mobilité & Environnement", text: "Comment les étudiants doivent-ils accéder au savoir ?", context: "La mobilité est un enjeu clé du plan climat.", didYouKnow: "Entre 2016 et 2023, l'usage de la voiture par le personnel est passé de 72% à 43%, tandis que le vélo a triplé (11% à 32%). L'arrivée de la Ligne 5 vise à réduire encore cette dépendance.", options: [{ text: "Ils n'ont plus besoin de se déplacer, tout est accessible depuis leur chambre.", impact: "s3" }, { text: "Par une ligne de tramway et des pistes cyclables connectant le campus au reste de la ville.", impact: "s1" }, { text: "Ils vivent, étudient et consomment sur place. Le campus est une ville piétonne autonome.", impact: "s6" }, { text: "Ils se déplacent constamment d'un tiers-lieu à l'autre dans la métropole.", impact: "s4" }] },
            { theme: "Innovation", text: "Quelle est la vocation principale de votre université ?", context: "Définir l'identité de l'institution pour 2050.", didYouKnow: "Montpellier mise sur 'MedVallée' (Santé/Environnement). L'université n'est plus isolée, elle devient un moteur économique direct et structurant pour le territoire métropolitain.", options: [{ text: "Être un moteur économique et produire des licornes (start-ups).", impact: "s2" }, { text: "Être un service public de proximité, fondu dans la population.", impact: "s4" }, { text: "Être un pôle d'excellence technologique piloté par la data.", impact: "s5" }, { text: "Être un sanctuaire du savoir, préservé et stable.", impact: "s1" }] },
            { theme: "Urbanisme", text: "L'Atrium (Learning Center) doit évoluer. Que devient-il ?", context: "Bâtiment emblématique de l'ouverture sur la ville.", didYouKnow: "L'Atrium a été construit sur un ancien parking. Il symbolise le passage du 'tout voiture' des années 60 à un espace piéton et végétalisé, redonnant 15 000 m² aux usagers.", options: [{ text: "Le centre névralgique d'une cité autonome, ouvert 24/24 avec tous les services.", impact: "s6" }, { text: "Un showroom technologique pour les entreprises partenaires.", impact: "s2" }, { text: "Un serveur géant gérant les avatars des étudiants.", impact: "s3" }, { text: "Un lieu de passage parmi d'autres dans la ville, ouvert à tous les citoyens.", impact: "s4" }] }
        ];

        let currentQuestionIndex = 0;
        let scores = { s1: 0, s2: 0, s3: 0, s4: 0, s5: 0, s6: 0 };
        let synth = window.speechSynthesis;
        let currentUtterance = null;
        let currentStoryText = "";
        let winnerScenarioId = null;

        function loadQuestion() {
            const q = questions[currentQuestionIndex];
            document.getElementById('current-question-num').innerText = currentQuestionIndex + 1;
            document.getElementById('enjeu-badge').innerText = q.theme;
            document.getElementById('question-text').innerText = q.text;
            document.getElementById('question-context').innerText = q.context;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex)/questions.length)*100}%`;
            const container = document.getElementById('answers-container'); container.innerHTML = '';
            [...q.options].sort(() => Math.random() - 0.5).forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all duration-200 flex items-center group card-hover";
                btn.onclick = () => handleAnswer(opt.impact);
                btn.innerHTML = `<div class="w-6 h-6 rounded-full border-2 border-gray-300 group-hover:border-indigo-500 mr-4 flex-shrink-0"></div><span class="text-gray-700 font-medium group-hover:text-indigo-900">${opt.text}</span>`;
                container.appendChild(btn);
            });
        }

        function handleAnswer(impact) {
            scores[impact]++;
            const fact = questions[currentQuestionIndex].didYouKnow;
            if(fact) {
                factText.innerText = fact;
                factOverlay.classList.remove('hidden');
                closeFactBtn.onclick = function() {
                    factOverlay.classList.add('hidden');
                    nextStep();
                };
            } else {
                nextStep();
            }
        }

        function nextStep() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) loadQuestion();
            else showImageReveal(); // MODIF : Passer par l'image d'abord
        }

        // ==========================================
        // NOUVELLE LOGIQUE IMAGE
        // ==========================================
        function showImageReveal() {
            questionScreen.classList.add('hidden');
            winnerScenarioId = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            
            // Format : "Scénario X.png" comme demandé (avec fallback jpg pour le preview)
            const scenarioNum = winnerScenarioId.replace('s', '');
            const imageName = `Scénario ${scenarioNum}.png`;
            
            scenarioRevealImg.src = imageName;
            scenarioImageOverlay.classList.remove('hidden');
            skipScenarioBtn.classList.add('hidden');

            // Timer de 5 secondes pour afficher le bouton passer
            if(imageTimer) clearTimeout(imageTimer);
            imageTimer = setTimeout(() => {
                skipScenarioBtn.classList.remove('hidden');
                skipScenarioBtn.classList.add('flex'); // Pour flexbox
                skipScenarioBtn.classList.add('fade-in');
            }, 5000);
        }

        function closeScenarioImage() {
            scenarioImageOverlay.classList.add('hidden');
            showResult(); // Affiche la page de résultat finale
        }

        // Fonction pour le bouton "Revoir l'illustration" (sans délai de 5s cette fois)
        function reopenScenarioImage() {
            scenarioImageOverlay.classList.remove('hidden');
            // Afficher le bouton fermer/passer immédiatement pour le confort
            skipScenarioBtn.classList.remove('hidden');
            skipScenarioBtn.innerHTML = `<span>Fermer</span> <i class="fas fa-times"></i>`;
        }
        // ==========================================

        function showResult() {
            resultScreen.classList.remove('hidden');
            
            // Remettre le texte original du bouton si on vient de "Revoir l'image"
            skipScenarioBtn.innerHTML = `<span>Accéder aux Résultats</span> <i class="fas fa-arrow-right"></i>`;

            if(currentPersona) {
                const p = personas[currentPersona];
                const feedbackTitle = document.getElementById('persona-feedback-title');
                const feedbackText = document.getElementById('persona-feedback-text');
                let titlePrefix = currentPersona === 'politique' ? "Le mot de l'Élu" : currentPersona === 'expert' ? "L'œil de l'Expert" : "L'avis de l'Étudiant(e)";
                feedbackTitle.innerText = `${titlePrefix} (${p.name})`;
                feedbackText.innerText = `"${p.quote}"`;
            }

            // APPEL FIREBASE
            enregistrerReponse(winnerScenarioId);

            const s = scenarios[winnerScenarioId];
            document.getElementById('scenario-title').innerText = s.title;
            document.getElementById('scenario-title').style.color = s.color;
            document.getElementById('scenario-subtitle').innerText = s.subtitle;
            document.getElementById('scenario-desc').innerText = s.description;
            const ul = document.getElementById('scenario-issues'); ul.innerHTML = '';
            s.issues.forEach(i => { const li = document.createElement('li'); li.innerText = i; ul.appendChild(li); });
            drawChart();
            currentStoryText = scenarioStories[winnerScenarioId];
            document.getElementById('story-text').innerText = currentStoryText;
            document.getElementById('story-display').classList.add('hidden');
            document.getElementById('reveal-btn').classList.remove('hidden');
            stopAudio();
            renderWordCloud();
        }

        // FIREBASE LOGIC
        async function enregistrerReponse(winningScenarioId) {
            if (!window.db || !window.doc) return;
            const statsRef = window.doc(window.db, "resultats", "global_stats");
            try {
                await window.updateDoc(statsRef, { [winningScenarioId]: window.increment(1), total: window.increment(1) });
                afficherResultats();
            } catch (e) {
                await window.setDoc(statsRef, { s1: winningScenarioId === 's1'?1:0, s2: winningScenarioId === 's2'?1:0, s3: winningScenarioId === 's3'?1:0, s4: winningScenarioId === 's4'?1:0, s5: winningScenarioId === 's5'?1:0, s6: winningScenarioId === 's6'?1:0, total: 1 });
                afficherResultats();
            }
        }

        async function afficherResultats() {
            if (!window.db || !window.doc) return;
            const statsRef = window.doc(window.db, "resultats", "global_stats");
            const docSnap = await window.getDoc(statsRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                const total = data.total || 1;
                let topScenario = 's1';
                let maxVotes = 0;
                for (const [key, value] of Object.entries(data)) {
                    if (key !== 'total' && value > maxVotes) { maxVotes = value; topScenario = key; }
                }
                const pourcentage = Math.round((maxVotes / total) * 100);
                const scenarioName = scenarios[topScenario] ? scenarios[topScenario].title.split('/')[0] : "Inconnu";
                document.getElementById("resultat-texte").innerHTML = `<i class="fas fa-users mr-2"></i>La communauté a choisi majoritairement : <br> <strong>${scenarioName} (${pourcentage}%)</strong>`;
            }
        }

        function drawChart() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            const labels = Object.keys(scenarios).map(k => scenarios[k].id);
            const data = Object.keys(scores).map(k => scores[k]);
            const colors = Object.keys(scenarios).map(k => scenarios[k].color);
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{ label: 'Points', data: data, backgroundColor: colors.map(c=>c+'80'), borderColor: colors, borderWidth: 1 }] },
                options: { scales: { y: { beginAtZero: true, max: 7 } }, plugins: { legend: { display: false } }, onClick: (e, el) => { if(el.length) openScenarioModal(Object.keys(scenarios)[el[0].index]); }, onHover: (e, el) => e.native.target.style.cursor = el.length ? 'pointer' : 'default' }
            });
        }

        const defaultWords = { "Mixité": 5, "Tram 5": 8, "Ouverture": 6, "ZAN": 3, "Végétalisation": 4, "Lien Social": 7, "Atrium": 5, "Innovation": 2, "Patrimoine": 3, "Mobilité": 5 };
        function getWords() {
            const stored = localStorage.getItem('atrium_words');
            if (stored) return JSON.parse(stored);
            localStorage.setItem('atrium_words', JSON.stringify(defaultWords));
            return defaultWords;
        }

        function addWord() {
            const input = document.getElementById('user-word');
            const word = input.value.trim();
            if(word && word.length < 20) {
                const formattedWord = word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                let words = getWords();
                words[formattedWord] = (words[formattedWord] || 0) + 1;
                localStorage.setItem('atrium_words', JSON.stringify(words));
                input.value = '';
                renderWordCloud();
            } else if (word.length >= 20) { alert("Mot trop long ! Essayez d'être concis."); }
        }

        function renderWordCloud() {
            const container = document.getElementById('word-cloud');
            container.innerHTML = '';
            const words = getWords();
            const colors = ['bg-indigo-100 text-indigo-800', 'bg-orange-100 text-orange-800', 'bg-blue-100 text-blue-800', 'bg-green-100 text-green-800', 'bg-gray-100 text-gray-700'];
            Object.entries(words).forEach(([text, count]) => {
                const span = document.createElement('span');
                let sizeClass = count > 8 ? 'text-xl font-bold' : count > 5 ? 'text-lg font-semibold' : count > 3 ? 'text-base font-medium' : count > 1 ? 'text-sm' : 'text-xs';
                const colorClass = colors[Math.floor(Math.random() * colors.length)];
                span.className = `word-tag px-3 py-1 rounded-full shadow-sm cursor-default select-none transition hover:scale-105 ${sizeClass} ${colorClass}`;
                span.innerText = text;
                span.title = `${count} contributions`;
                container.appendChild(span);
            });
        }
        window.addEventListener('storage', (e) => { if (e.key === 'atrium_words') renderWordCloud(); });

        // ATLAS DATA ENRICHIE AVEC LE PDF
        const atlasData = {
            usa: { 
                country: "États-Unis", 
                content: `
                    <p class="font-bold text-orange-600 mb-1">Puissance & Classements</p>
                    <p>Avec <strong>38 universités dans le top 100</strong> (Shanghai 2024), les USA dominent. Harvard est #1 depuis 22 ans.</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="font-bold text-indigo-600 mb-1">Modèle Campus Géant</p>
                    <p>Le <strong>Berry College</strong> s'étend sur 110 km², soit la taille de Paris !</p>
                    <p>Coût moyen : 11 950$ à 31 880$/an (vs ~200€ en France).</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="text-sm italic">Accueille 20% des étudiants internationaux de l'OCDE.</p>
                ` 
            },
            europe: { 
                country: "Europe & France", 
                content: `
                    <p class="font-bold text-green-600 mb-1">Accès Massif</p>
                    <p>Taux d'inscription de <strong>79%</strong> (vs 43% moyenne mondiale).</p>
                    <p>L'Europe compte 19.2% des institutions mondiales pour seulement 10% de la population.</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="font-bold text-indigo-600 mb-1">Focus France</p>
                    <p>L'<strong>Université Paris-Saclay</strong> est 13ème mondiale (Shanghai 2025). La France accueille 364 756 étudiants internationaux (5% mondial).</p>
                ` 
            },
            uk: { 
                country: "Royaume-Uni", 
                content: `
                    <p class="font-bold text-indigo-600 mb-1">Excellence Européenne</p>
                    <p><strong>Oxford</strong> (#1) et Cambridge (#3) dominent le classement européen QS 2024.</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="font-bold text-orange-600 mb-1">Attractivité</p>
                    <p>Accueille <strong>633 910 étudiants internationaux</strong> (14% des étudiants mobiles OCDE).</p>
                    <p>Un modèle hybride puissant alliant tradition et export du savoir.</p>
                ` 
            },
            china: { 
                country: "Chine", 
                content: `
                    <p class="font-bold text-red-600 mb-1">Explosion Scientifique</p>
                    <p>#1 Mondial en production scientifique avec <strong>898 949 articles</strong> publiés en 2022 (+96% depuis 2010).</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="font-bold text-indigo-600 mb-1">Montée en puissance</p>
                    <p>225 universités dans le top 1000 mondial. La Chine est le 2ème pays avec le plus d'universités classées.</p>
                ` 
            },
            india: { 
                country: "Inde", 
                content: `
                    <p class="font-bold text-orange-600 mb-1">Record du Monde</p>
                    <p>Compte <strong>8 410 universités</strong>, le plus grand nombre au monde !</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="font-bold text-indigo-600 mb-1">Gigantisme</p>
                    <p>L'Université <strong>G.B. Pant</strong> est 116 fois plus grande que le Vatican.</p>
                    <p>Un défi colossal : +268% d'étudiants entre 2000 et 2020.</p>
                ` 
            },
            philippines: {
                country: "Philippines / Asie SE",
                content: `
                    <p class="font-bold text-blue-600 mb-1">Densité Extrême</p>
                    <p>L'université <strong>UP Diliman</strong> accueille 47 627 étudiants sur seulement 5 km².</p>
                    <p>C'est 22x plus compact que le Berry College américain.</p>
                    <div class="h-px bg-gray-200 my-4"></div>
                    <p class="font-bold text-indigo-600 mb-1">Dynamique Régionale</p>
                    <p>L'Asie de l'Est et du Sud-Est représente 58% des étudiants internationaux mobiles de l'OCDE.</p>
                `
            }
        };

        const atlasModal = document.getElementById('atlas-modal');
        const atlasInfoBox = document.getElementById('atlas-info-box');
        
        function openAtlas() { atlasModal.classList.remove('hidden'); }
        function closeAtlas() { atlasModal.classList.add('hidden'); hideAtlasFact(); }
        
        function showAtlasFact(countryKey) {
            const data = atlasData[countryKey];
            if(!data) return;
            document.getElementById('atlas-country').innerText = data.country;
            document.getElementById('atlas-content').innerHTML = data.content;
            
            // Affichage en grand (fixed overlay)
            atlasInfoBox.classList.remove('hidden');
            atlasInfoBox.classList.add('flex'); // Important pour le layout
        }
        
        function hideAtlasFact() { 
            atlasInfoBox.classList.add('hidden');
            atlasInfoBox.classList.remove('flex');
        }
        
        // Fermer Atlas en cliquant dehors
        atlasModal.addEventListener('click', (e) => { if (e.target === atlasModal) closeAtlas(); });


        function showWorks() { 
            resultScreen.classList.add('hidden'); worksScreen.classList.remove('hidden'); 
            stopAudio(); window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function closeWorks() { worksScreen.classList.add('hidden'); resultScreen.classList.remove('hidden'); }
        
        const modal = document.getElementById('scenario-modal');
        function openScenarioModal(key) {
            const s = scenarios[key];
            document.getElementById('modal-id').innerText = s.id; document.getElementById('modal-id').style.color = s.color;
            document.getElementById('modal-title').innerText = s.title; document.getElementById('modal-subtitle').innerText = s.subtitle;
            document.getElementById('modal-desc').innerText = s.description;
            modal.classList.remove('hidden');
        }
        function closeModal() { modal.classList.add('hidden'); }
        modal.addEventListener('click', e => { if(e.target === modal) closeModal(); });

        const pdfModal = document.getElementById('pdf-modal');
        const commsPdfs = [
            { file: "PAGE DE GARDE.pdf", title: "Page de Garde" },
            { file: "DE L’HISTOIRE A LA PLANIFICATION  LE CAS MONTPELLIERAIN.pdf", title: "Histoire & Planification" },
            { file: "LES DIFFÉRENTS MODÈLES DE CONSTRCUTION DES UNIVERSITÉS.pdf", title: "Modèles de Construction" },
            { file: "PLAN DE MASSE-1.pdf", title: "Plan de Masse" }
        ];
        let currentPdfIndex = 0; let currentPdfList = [];
        function openCommsGallery() { currentPdfList = commsPdfs; currentPdfIndex = 0; updatePdfViewer(); pdfModal.classList.remove('hidden'); }
        function updatePdfViewer() {
            const pdfObj = currentPdfList[currentPdfIndex];
            document.getElementById('pdf-title').innerHTML = `<i class="fas fa-book-open mr-2"></i> ${pdfObj.title}`;
            document.getElementById('page-indicator').innerText = `Page ${currentPdfIndex + 1} / ${currentPdfList.length}`;
            const container = document.getElementById('pdf-container'); container.innerHTML = '';
            const objectTag = document.createElement('object');
            objectTag.data = pdfObj.file; objectTag.type = "application/pdf";
            objectTag.className = "w-full h-full"; objectTag.style.minHeight = "100%";
            objectTag.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-500 p-4 text-center"><p class="mb-4"><i class="fas fa-file-pdf text-4xl text-red-500 mb-2"></i><br>L'affichage intégré n'est pas supporté par votre mobile.</p><a href="${pdfObj.file}" target="_blank" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition flex items-center gap-2"><i class="fas fa-external-link-alt"></i> Ouvrir le PDF (Zoomable)</a></div>`;
            container.appendChild(objectTag);
            document.getElementById('btn-prev').disabled = (currentPdfIndex === 0);
            document.getElementById('btn-next').disabled = (currentPdfIndex === currentPdfList.length - 1);
            document.getElementById('btn-prev').classList.toggle('opacity-50', currentPdfIndex === 0);
            document.getElementById('btn-next').classList.toggle('opacity-50', currentPdfIndex === currentPdfList.length - 1);
        }
        function nextPdf() { if (currentPdfIndex < currentPdfList.length - 1) { currentPdfIndex++; updatePdfViewer(); } }
        function prevPdf() { if (currentPdfIndex > 0) { currentPdfIndex--; updatePdfViewer(); } }
        function closePdfModal() { pdfModal.classList.add('hidden'); document.getElementById('pdf-container').innerHTML = ''; }
        pdfModal.addEventListener('click', e => { if(e.target === pdfModal) closePdfModal(); });

        const timelineData = [
            { year: 1220, title: "Fondation Faculté Médecine", desc: "La plus ancienne faculté de médecine en activité au monde, marquant l'identité 'ville de savoir'.", side: "left" },
            { year: 1289, title: "Bulle Papale", desc: "Création officielle de l'Université de Montpellier (Médecine, Droit) par le Pape Nicolas IV.", side: "right" },
            { year: 1593, title: "Jardin des Plantes", desc: "Création du plus ancien jardin botanique de France par Henri IV, pour la recherche médicale.", side: "left" },
            { year: 1966, title: "Inauguration Campus", desc: "Le campus Paul Valéry est inauguré au nord de la ville. Un modèle 'américain' excentré et isolé.", side: "right" },
            { year: 1971, title: "Université Paul Valéry", desc: "Naissance de l'Université Montpellier III (Lettres & Sciences Humaines) suite à la Loi Faure.", side: "left" },
            { year: 2008, title: "Opération Campus", desc: "Lancement du plan national de rénovation. Montpellier est l'une des 6 villes lauréates.", side: "right" },
            { year: 2011, title: "Label Patrimoine XXe", desc: "Reconnaissance de l'architecture singulière du campus (Egger, Jaulmes) comme patrimoine remarquable.", side: "left" },
            { year: 2023, title: "Livraison de l'Atrium", desc: "Ouverture du Learning Center (15 000 m²), conçu comme une porte ouverte sur la ville.", side: "right" },
            { year: 2025, title: "Tramway Ligne 5", desc: "Désenclavement majeur du campus nord avec une desserte directe. Couture urbaine 'Ville-Campus'.", side: "left" }
        ];

        const timelineModal = document.getElementById('timeline-modal');
        function openTimeline() {
            const container = document.getElementById('timeline-content');
            container.innerHTML = '';
            timelineData.forEach((item, index) => {
                const isLeft = item.side === 'left'; const delay = index * 100;
                const cardHtml = `<div class="relative w-full h-32 md:h-24 mb-8 fade-in" style="animation-delay: ${delay}ms"><div class="timeline-point" style="top: 15px;"></div><div class="absolute top-0 timeline-card ${item.side}"><div class="bg-white p-4 rounded-lg shadow-md border-l-4 ${isLeft ? 'border-orange-500' : 'border-indigo-500'} hover:shadow-lg transition-shadow"><span class="text-2xl font-bold text-gray-200 absolute top-2 ${isLeft ? 'right-4' : 'left-4'} select-none z-0">${item.year}</span><div class="relative z-10"><h4 class="font-bold text-indigo-900 text-lg">${item.title}</h4><p class="text-sm text-gray-600 leading-snug">${item.desc}</p></div></div></div></div>`;
                container.innerHTML += cardHtml;
            });
            timelineModal.classList.remove('hidden');
        }
        function closeTimeline() { timelineModal.classList.add('hidden'); }
        timelineModal.addEventListener('click', e => { if(e.target === timelineModal) closeTimeline(); });

        const cguModal = document.getElementById('cgu-modal');
        function openCgu() { cguModal.classList.remove('hidden'); }
        function closeCgu() { cguModal.classList.add('hidden'); }
        cguModal.addEventListener('click', (e) => { if(e.target === cguModal) closeCgu(); });

        const statsModal = document.getElementById('stats-modal');
        let statsChart = null;
        const statsData = [
            { type: 'pie', title: "Montpellier, Ville Étudiante", desc: "1 habitant sur 4 est étudiant (26,1%). Une proportion qui façonne l'urbain.", data: { labels: ['Étudiants', 'Reste de la population'], datasets: [{ data: [26.1, 73.9], backgroundColor: ['#F97316', '#E5E7EB'], borderWidth: 0 }] } },
            { type: 'doughnut', title: "Une Université Fragmentée", desc: "Répartition des étudiants par campus : une constellation éclatée plutôt qu'un centre unique.", data: { labels: ['Route de Mende', 'Triolet', 'Richter', 'Saint-Priest', 'Santé', 'Autres'], datasets: [{ data: [29.2, 20.8, 16.7, 13.9, 11.1, 8.3], backgroundColor: ['#4F46E5', '#3B82F6', '#6366F1', '#818CF8', '#A5B4FC', '#C7D2FE'], borderWidth: 2, borderColor: '#ffffff' }] } },
            { type: 'radar', title: "Moyens & Personnels", desc: "Comparaison des ressources (Budget/Étudiant vs Personnels) entre grandes universités.", data: { labels: ['Aix-Marseille', 'Lyon 1', 'U. Montpellier', 'Lille', 'Paris-Saclay', 'Paul-Valéry', 'Toulouse'], datasets: [{ label: 'Budget / Étudiant (€)', data: [10850, 10600, 9825, 7500, 8300, 7000, 5500], fill: true, backgroundColor: 'rgba(249, 115, 22, 0.2)', borderColor: 'rgb(249, 115, 22)', pointBackgroundColor: 'rgb(249, 115, 22)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(249, 115, 22)' }, { label: 'Personnels', data: [8000, 4900, 4800, 8000, 11000, 1500, 3100], fill: true, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: 'rgb(79, 70, 229)', pointBackgroundColor: 'rgb(79, 70, 229)', pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(79, 70, 229)' }] }, options: { elements: { line: { borderWidth: 3 } }, scales: { r: { angleLines: { display: true }, suggestedMin: 0 } } } }
        ];

        function openStats() { statsModal.classList.remove('hidden'); setTimeout(() => renderStat(0), 100); }
        function closeStats() { statsModal.classList.add('hidden'); if(statsChart) { statsChart.destroy(); statsChart = null; } }
        function renderStat(index) {
            const ctx = document.getElementById('statsCanvas').getContext('2d'); const stat = statsData[index];
            document.getElementById('stat-title').innerText = stat.title; document.getElementById('stat-desc').innerText = stat.desc;
            if (statsChart) statsChart.destroy();
            statsChart = new Chart(ctx, { type: stat.type, data: stat.data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, ...stat.options } });
        }
        statsModal.addEventListener('click', (e) => { if(e.target === statsModal) closeStats(); });

        function revealStory() { document.getElementById('reveal-btn').classList.add('hidden'); document.getElementById('story-display').classList.remove('hidden'); stopAudioUI(); }
        function playAudio() {
            document.getElementById('play-audio-btn').classList.add('hidden'); document.getElementById('stop-audio-btn').classList.remove('hidden'); document.getElementById('speaking-indicator').classList.remove('hidden');
            if(synth.speaking) synth.cancel();
            currentUtterance = new SpeechSynthesisUtterance(currentStoryText);
            currentUtterance.lang = 'fr-FR'; currentUtterance.rate = 0.9; currentUtterance.pitch = 0.9;
            currentUtterance.onend = stopAudioUI;
            synth.speak(currentUtterance);
        }
        function stopAudio() { if(synth.speaking) synth.cancel(); stopAudioUI(); }
        function stopAudioUI() { document.getElementById('play-audio-btn').classList.remove('hidden'); document.getElementById('stop-audio-btn').classList.add('hidden'); document.getElementById('speaking-indicator').classList.add('hidden'); }

        function restartGame() {
            stopAudio(); currentQuestionIndex = 0; scores = { s1: 0, s2: 0, s3: 0, s4: 0, s5: 0, s6: 0 };
            document.getElementById('story-display').classList.add('hidden'); resultScreen.classList.add('hidden'); 
            introScreen.classList.remove('hidden'); 
            currentPersona = null;
            document.querySelectorAll('.persona-card').forEach(el => el.classList.remove('selected-persona', 'ring-2', 'ring-indigo-500'));
            const btn = document.getElementById('start-btn');
            btn.disabled = true; btn.classList.add('bg-gray-300', 'cursor-not-allowed'); btn.classList.remove('bg-orange-500', 'hover:bg-orange-600', 'cursor-pointer'); btn.innerText = "Choisir un personnage";
            // Reset slider state (pas besoin car il est dans le modal maintenant)
        }

        // --- LOGIQUE MODAL ATRIUM (NOUVEAU) ---
        const atriumModal = document.getElementById('atrium-modal');
        const atriumAfterImg = document.getElementById('atrium-after-img');
        
        function openAtrium() {
            atriumModal.classList.remove('hidden');
            
            // Charger l'image du scénario gagnant ou défaut S1
            const scenarioId = winnerScenarioId || 's1';
            setAtriumScenario(scenarioId.toUpperCase());
        }

        function closeAtrium() {
            atriumModal.classList.add('hidden');
        }

        function setAtriumScenario(scenarioId) {
            // Format: "S1"
            const safeId = scenarioId.toUpperCase(); // S1
            const imageName = `${safeId} Atrium.png`;
            
            atriumAfterImg.src = imageName;
            atriumAfterImg.onerror = function() { 
                this.onerror = null; 
                this.src = this.src.replace('.png', '.jpg'); 
            };

            // Mise à jour UI boutons
            document.querySelectorAll('.btn-scenario').forEach(btn => {
                btn.classList.remove('active');
                if(btn.id === `btn-${safeId.toLowerCase()}`) btn.classList.add('active');
            });

            // Mise à jour du texte descriptif
            const s = scenarios[safeId.toLowerCase()];
            const label = document.getElementById('atrium-scenario-label');
            if (s && label) {
                label.innerHTML = `<span style="color:${s.color}" class="font-bold">${s.title}</span> : ${s.subtitle}`;
            }
        }

        // --- LOGIQUE DU SLIDER AVANT/APRÈS ---
        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('atrium-comparison-slider');
            const beforeContainer = slider.querySelector('.before-image-container');
            const handle = slider.querySelector('.comparison-handle');
            let isDragging = false;

            const getPositionX = (event) => {
                const rect = slider.getBoundingClientRect();
                let clientX = event.clientX || event.touches[0].clientX;
                let x = clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width)); 
                return (x / rect.width) * 100; 
            };

            const moveSlider = (xPercent) => {
                beforeContainer.style.width = `${xPercent}%`;
                handle.style.left = `${xPercent}%`;
            };

            // Mouse events
            slider.addEventListener('mousedown', (e) => { isDragging = true; moveSlider(getPositionX(e)); });
            window.addEventListener('mouseup', () => { isDragging = false; });
            window.addEventListener('mousemove', (e) => { if (!isDragging) return; moveSlider(getPositionX(e)); });

            // Touch events (pour mobile)
            slider.addEventListener('touchstart', (e) => { isDragging = true; moveSlider(getPositionX(e)); }, { passive: true });
            window.addEventListener('touchend', () => { isDragging = false; });
            window.addEventListener('touchmove', (e) => { if (!isDragging) return; moveSlider(getPositionX(e)); }, { passive: true });

            // Centrer au départ
            moveSlider(50);
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, updateDoc, getDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyAe7Hc2bT-Scvf032sLHh8TXG9aHnFB-D0", authDomain: "atelier-atrium-d951b.firebaseapp.com", projectId: "atelier-atrium-d951b", storageBucket: "atelier-atrium-d951b.firebasestorage.app", messagingSenderId: "716967590598", appId: "1:716967590598:web:5116e96917e2243fcbb5c7", measurementId: "G-JQ634TGS4M" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db; window.doc = doc; window.updateDoc = updateDoc; window.increment = increment; window.getDoc = getDoc; window.setDoc = setDoc;
    </script>
</body>
</html>
